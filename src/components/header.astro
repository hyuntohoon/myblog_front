---
import { HEADER, SITE } from '@constants'
import Spacer from './spacer.astro'
import Link from './link.astro'
import Search from './search.astro'

const { pathname } = Astro.url

const normalize = (p: string) => (p.endsWith('/') ? p : p + '/')
const isActive = (url: string) => normalize(pathname) === normalize(url)

const dedupeByUrl = <T extends { url: string }>(arr: T[]) =>
  Array.from(new Map(arr.map(i => [i.url, i])).values())

const internal = dedupeByUrl(HEADER.internal ?? [])
const external = dedupeByUrl(HEADER.external ?? [])
---
<script src="../scripts/header.client.ts"></script>
<header class="container">
  <Spacer axis="vertical" size={8} />
  <div class="flex flex-row justify-between items-center">
    <div class="flex items-center gap-4">
      <a
        class="font-semibold text-xl md:text-2xl lg:text-3xl text-highlight"
        href="/"
        aria-label={`${SITE.title} - Back to home`}
      >{SITE.title}</a>

      <!-- ✅ 슬래시 추가 -->
      <a id="write-link" href="/write/" class="hidden text-base md:text-lg">Write</a>
    </div>
    <div class="flex items-center gap-3">
      <Search />
      <button id="login-btn" class="text-base md:text-lg">Login</button>
      <button id="logout-btn" class="hidden text-base md:text-lg">Logout</button>
    </div>
  </div>

  <Spacer axis="vertical" size={6} />
  <div class="flex flex-row justify-between items-center border-b border-border pb-4 text-lg md:text-xl">
    <nav aria-label="Primary navigation" class="flex gap-4">
      {
        internal.map((link) => (
          <Link
            href={normalize(link.url)}  <!-- ✅ 모든 내부 링크 normalize -->
            class={isActive(link.url) ? 'active' : ''}
            aria-current={isActive(link.url) ? 'page' : undefined}
          >
            {link.title}
          </Link>
        ))
      }
    </nav>
    <div class="flex gap-4">
      {
        external.map((link) => (
          <Link href={link.url} {...(link.props ?? {})}>
            {link.title}
          </Link>
        ))
      }
    </div>
  </div>

  <Spacer axis="vertical" size={4} />
</header>