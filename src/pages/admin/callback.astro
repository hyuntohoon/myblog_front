---
/* src/pages/admin/callback.astro */
---
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ë¡œê·¸ì¸ ì²˜ë¦¬ì¤‘â€¦</title>
    <meta name="robots" content="noindex" />
  </head>
  <body>
    <p id="msg">ë¡œê·¸ì¸ ì²˜ë¦¬ì¤‘â€¦</p>
    <button id="retry" class="hidden">ë‹¤ì‹œ ë¡œê·¸ì¸</button>

    <script type="module">
      import { handleCallback, goLogin } from '/src/lib/auth.ts';

      const log = (m) => {
        console.log(m);
        const el = document.getElementById('msg');
        if (el) el.textContent = m;
      };

      async function run() {
        try {
          log('ğŸ”„ ì½œë°± ì²˜ë¦¬ ì‹œì‘â€¦');

          const qs = new URLSearchParams(location.search);
          const code = qs.get('code');
          const state = qs.get('state');
          const verifier = sessionStorage.getItem('pkce_verifier');
          const savedState = sessionStorage.getItem('oauth_state');

          console.log('[callback]', { code, state, verifierExists: !!verifier, savedState });

          if (!code) {
            log('âŒ code ì—†ìŒ. ë‹¤ì‹œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤â€¦');
            await goLogin(true);
            return;
          }
          if (!verifier || !savedState || savedState !== state) {
            log('âš ï¸ ì„¸ì…˜ ë§Œë£Œ/ìƒˆ íƒ­ ë¬¸ì œ. ë‹¤ì‹œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤â€¦');
            await goLogin(true);
            return;
          }

          log('ğŸ”‘ í† í° êµí™˜ ì¤‘â€¦');
          await handleCallback(); // í† í° ì €ì¥

          log('âœ… ë¡œê·¸ì¸ ì™„ë£Œ. ì´ë™í•©ë‹ˆë‹¤â€¦');
          location.replace('/write');  // ì„±ê³µ í›„ ì´ë™í•  í˜ì´ì§€
        } catch (e) {
          console.error(e);
          log('âŒ ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨: ' + (e?.message ?? String(e)));
          document.getElementById('retry')?.classList.remove('hidden');
        }
      }

      document.getElementById('retry')?.addEventListener('click', () => goLogin(true));
      run();
    </script>
  </body>
</html>