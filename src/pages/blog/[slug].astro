---
import type { CollectionEntry } from 'astro:content'
import { getCollection, render } from 'astro:content'
import Seo from '@components/seo.astro'
import Layout from '@layouts/layout.astro'
import Prose from '@components/prose.astro'
import { SITE } from '@constants'
import { defaultDateFormat, isoDateFormat } from '@utils'
import SkipNavContent from '@components/a11y/skip-nav-content.astro'
import Spacer from '@components/spacer.astro'
import Aside from '@components/aside.astro'
import Playground from '@components/playground.astro'

// í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (ì•¨ë²” ë””í…Œì¼ ë Œë”ëŸ¬)
const detailClient = '/src/scripts/albumDetail.client.ts'
// ðŸ”¹ ìƒˆë¡œ ì¶”ê°€: fetch ì „ë‹´ ìŠ¤í¬ë¦½íŠ¸
const detailFetchClient = '/src/scripts/albumDetail.fetch.client.ts'

export const prerender = true

export async function getStaticPaths() {
  const entries = await getCollection('blog')
  return entries.map((e) => ({
    params: { slug: e.data.slug },
    props: { entry: e },
  }))
}

const { entry } = Astro.props as { entry: CollectionEntry<'blog'> }
const post = entry.data
const { Content } = await render(entry)

const allPosts = await getCollection('blog')
const siblings = allPosts.sort(
  (a, b) => +new Date(b.data.date) - +new Date(a.data.date)
)
---

<Layout>
  <Seo slot="seo" forceTitle={post.title} description={post.description} image={post.image}>
    <meta name="twitter:label1" value="Author" />
    <meta name="twitter:data1" data-pagefind-meta="author" value={SITE.defaultAuthor} />
    <meta name="article:published_time" data-pagefind-meta="published_time" content={isoDateFormat(post.date)} />
    <meta name="article:modified_time" data-pagefind-meta="modified_time" content={isoDateFormat(post.lastUpdated)} />
    <meta name="article:section" content={post.category} />
  </Seo>

  <SkipNavContent searchIndex={post.searchIndex}>
    <Prose>
      <h1 class="mb-0!" data-pagefind-meta="title">{post.title}</h1>

      <section
        id="music-section"
        class="mt-4 border-t border-gray-200 pt-0"
        data-album-ids={JSON.stringify(post.albumIds ?? [])}
        data-artist-ids={JSON.stringify(post.artistIds ?? [])}
      >
        <div id="albumDetail"></div>
      </section>

      <Spacer axis="vertical" size={4} />

      <div class="text-faded">
        {defaultDateFormat(post.date)}
      </div>

      <Content components={{ Aside, Playground }} />
    </Prose>
  </SkipNavContent>
</Layout>

<!-- ðŸŽ§ ì•¨ë²” ë””í…Œì¼ ë Œë”ëŸ¬ -->
<script type="module" src={detailClient}></script>

<!-- ðŸŽ§ fetch + ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜ ì „ë‹´ ìŠ¤í¬ë¦½íŠ¸ -->
<script type="module" src={detailFetchClient}></script>