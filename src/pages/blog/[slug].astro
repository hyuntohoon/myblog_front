---
import type { CollectionEntry } from 'astro:content'
import { getCollection, render } from 'astro:content'
import Seo from '@components/seo.astro'
import Layout from '@layouts/layout.astro'
import Prose from '@components/prose.astro'
import { SITE } from '@constants'
import { defaultDateFormat, isoDateFormat } from '@utils'
import SkipNavContent from '@components/a11y/skip-nav-content.astro'
import Spacer from '@components/spacer.astro'
import Aside from '@components/aside.astro'
import Playground from '@components/playground.astro'
import PostGrid from '@components/post-grid.astro'

const detailClient = '/src/scripts/albumDetail.client.ts'
const detailFetchClient = '/src/scripts/albumDetail.fetch.client.ts'

export const prerender = true

export async function getStaticPaths() {
  const entries = await getCollection('blog')
  return entries.map((e) => ({
    params: { slug: e.data.slug },
    props: { entry: e },
  }))
}

const { entry } = Astro.props as { entry: CollectionEntry<'blog'> }
const post = entry.data
const { Content } = await render(entry)

const allPosts = await getCollection('blog', ({ data }) => !data.draft)
const posts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
---

<Layout>
  <Seo slot="seo" forceTitle={post.title} description={post.description} image={post.image}>
    <meta name="twitter:label1" value="Author" />
    <meta name="twitter:data1" data-pagefind-meta="author" value={SITE.defaultAuthor} />
    <meta name="article:published_time" data-pagefind-meta="published_time" content={isoDateFormat(post.date)} />
    <meta name="article:modified_time" data-pagefind-meta="modified_time" content={isoDateFormat(post.lastUpdated)} />
    <meta name="article:section" content={post.category} />
  </Seo>

  {/* ⬇️ 여기는 그대로: SkipNavContent가 <main class="container"> 를 렌더링함 */}
  <SkipNavContent searchIndex={post.searchIndex}>
    <Prose>
      <h1 class="mb-0!" data-pagefind-meta="title">{post.title}</h1>

      <section
        id="music-section"
        class="mt-4 border-t border-gray-200 pt-0"
        data-album-ids={JSON.stringify(post.albumIds ?? [])}
        data-artist-ids={JSON.stringify(post.artistIds ?? [])}
      >
        <div id="albumDetail"></div>
      </section>

      <Spacer axis="vertical" size={4} />

      <div class="text-faded">
        {defaultDateFormat(post.date)}
      </div>

      <Content components={{ Aside, Playground }} />
    </Prose>
  </SkipNavContent>

  {/* ⬇️ All Posts도 동일하게 container 사용 */}
  <section class="container mt-12">
    <h2 class="text-xl font-bold mb-6">All Posts</h2>
    <PostGrid posts={posts} />
    <Spacer axis="vertical" size={8} />
  </section>
</Layout>

<script type="module" src={detailClient}></script>
<script type="module" src={detailFetchClient}></script>