---
import Layout from '@layouts/layout.astro'
import Seo from '@components/seo.astro'
import SkipNavContent from '@components/a11y/skip-nav-content.astro'
import { getCollection } from 'astro:content'
import { defaultDateFormat } from '@utils'
import Link from '@components/link.astro'
import PostMetricsItem from '@components/post-metrics'

const isHome = Astro.url.pathname === '/'

// 최신순 정렬
const byDateDesc = (a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
const allPosts = (await getCollection('blog')).sort(byDateDesc)

const limit = 5
const posts = isHome ? allPosts.slice(0, limit) : allPosts
---

<Layout>
  <Seo slot="seo" title={isHome ? 'Recent Posts' : 'Blog'} />

  <SkipNavContent>
    {isHome ? (
      <>
        <h2 class="text-base font-semibold mb-4">Recent {limit} Posts</h2>

        <div class="text-faded border-b border-border pb-2 mb-2
                    grid grid-cols-[auto_1fr_auto_auto] gap-x-3 items-center text-sm">
          <span>Category</span>
          <span>Title</span>
          <span>Date</span>
          <span>Metrics</span>
        </div>

        <div class="divide-y divide-border">
          {posts.map(({ data: post }) => (
            <div class="grid grid-cols-[auto_1fr_auto_auto] gap-x-3 items-center py-3">
              <Link
                href={`/blog/category/${encodeURIComponent(post.category)}/`}
                class="font-mono text-xs md:text-sm px-1.5 py-0.5 rounded border border-border text-faded hover:text-highlight"
              >
                [{post.category}]
              </Link>

              <Link
                variant="highlight"
                class="font-medium text-base md:text-lg truncate"
                href={`/blog/${post.slug}/`}
                title={post.title}
              >
                {post.title}
              </Link>

              <span class="text-faded whitespace-nowrap text-sm">
                {defaultDateFormat(post.date)}
              </span>

              <span class="text-faded whitespace-nowrap text-sm">
                <PostMetricsItem client:load slug={post.slug} />
              </span>
            </div>
          ))}
        </div>

        <div class="mt-4 text-right">
          <Link href="/blog" class="text-sm text-faded hover:text-highlight">
            all posts →
          </Link>
        </div>
      </>
    ) : (
      <>
        <h1 class="sr-only">Blog</h1>

        <div class="text-faded border-b border-border pb-2 mb-2
                    grid grid-cols-[auto_1fr_auto_auto] gap-x-3 items-center">
          <span class="text-sm">Category</span>
          <span class="text-sm">Title</span>
          <span class="text-sm">Date</span>
          <span class="text-sm">Metrics</span>
        </div>

        <div class="divide-y divide-border">
          {posts.map(({ data: post }) => (
            <div class="grid grid-cols-[auto_1fr_auto_auto] gap-x-3 items-center py-3">
              <Link
                href={`/blog/category/${encodeURIComponent(post.category)}/`}
                class="font-mono text-xs md:text-sm px-1.5 py-0.5 rounded border border-border text-faded hover:text-highlight"
              >
                [{post.category}]
              </Link>

              <Link
                variant="highlight"
                class="font-medium text-base md:text-lg truncate"
                href={`/blog/${post.slug}/`}
                title={post.title}
              >
                {post.title}
              </Link>

              <span class="text-faded whitespace-nowrap">
                {defaultDateFormat(post.date)}
              </span>

              <span class="text-faded whitespace-nowrap">
                <PostMetricsItem client:load slug={post.slug} />
              </span>
            </div>
          ))}
        </div>
      </>
    )}
  </SkipNavContent>
</Layout>