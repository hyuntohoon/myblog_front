---
import Layout from '@layouts/layout.astro'
import Seo from '@components/seo.astro'
import SkipNavContent from '@components/a11y/skip-nav-content.astro'
import { getCollection } from 'astro:content'
import PostList from '@components/post-list.astro'
import PostGrid from '@components/post-grid.astro'
import Link from '@components/link.astro'

const isHome = Astro.url.pathname === '/'

const byDateDesc = (a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
const allPosts = (await getCollection('blog')).sort(byDateDesc)

const PER_PAGE = 30
const pageParam = Number(Astro.url.searchParams.get('page') ?? '1')
const currentPage = Number.isFinite(pageParam) && pageParam > 0 ? pageParam : 1
const totalPages = Math.ceil(allPosts.length / PER_PAGE)
const start = (currentPage - 1) * PER_PAGE
const posts = allPosts.slice(start, start + PER_PAGE)

const basePath = isHome ? '/' : '/blog'
---

<Layout>
  <Seo slot="seo" title={isHome ? 'Recent Posts' : 'Blog'} />

  <SkipNavContent>
    <section class="max-w-4xl ">
      <!-- Ìó§Îçî + Î≤ÑÌäº -->
      <div class="flex items-center justify-between mb-4">
        {isHome ? (
          <h2 class="text-base font-semibold">Recent Posts</h2>
        ) : (
          <h1 class="text-lg font-semibold">Blog</h1>
        )}

        <div class="inline-flex items-center rounded border border-gray-300 overflow-hidden text-xs">
          <button id="listViewBtn" class="px-3 py-1 bg-gray-900 text-white">List</button>
          <button id="gridViewBtn" class="px-3 py-1 bg-white text-gray-700 hover:bg-gray-100">Grid</button>
        </div>
      </div>

      <!-- Î¶¨Ïä§Ìä∏ Î∑∞ -->
      <div id="list-view">
        <PostList posts={posts} />
      </div>

      <!-- Í∑∏Î¶¨Îìú Î∑∞ -->
      <div id="grid-view" class="hidden">
        <PostGrid posts={posts} />
      </div>

      <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
      <div class="mt-6 flex items-center justify-between text-sm text-faded">
        {currentPage > 1 ? (
          <Link
            href={currentPage === 2 ? basePath : `${basePath}?page=${currentPage - 1}`}
            class="hover:text-highlight"
          >
            ‚Üê Prev
          </Link>
        ) : (
          <span class="opacity-40">‚Üê Prev</span>
        )}

        <span>Page {currentPage} / {totalPages}</span>

        {currentPage < totalPages ? (
          <Link
            href={`${basePath}?page=${currentPage + 1}`}
            class="hover:text-highlight"
          >
            Next ‚Üí
          </Link>
        ) : (
          <span class="opacity-40">Next ‚Üí</span>
        )}
      </div>
    </section>
  </SkipNavContent>

  <!-- üö´ Ïô∏Î∂Ä ÌååÏùº ÏóÜÏù¥ ÏàúÏàò inline Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const listBtn = document.getElementById('listViewBtn');
      const gridBtn = document.getElementById('gridViewBtn');
      const listView = document.getElementById('list-view');
      const gridView = document.getElementById('grid-view');

      if (!listBtn || !gridBtn || !listView || !gridView) return;

      const setView = (view) => {
        const isList = view === 'list';
        listView.classList.toggle('hidden', !isList);
        gridView.classList.toggle('hidden', isList);

        listBtn.classList.toggle('bg-gray-900', isList);
        listBtn.classList.toggle('text-white', isList);
        listBtn.classList.toggle('bg-white', !isList);
        listBtn.classList.toggle('text-gray-700', !isList);

        gridBtn.classList.toggle('bg-gray-900', !isList);
        gridBtn.classList.toggle('text-white', !isList);
        gridBtn.classList.toggle('bg-white', isList);
        gridBtn.classList.toggle('text-gray-700', isList);
      };

      listBtn.addEventListener('click', () => setView('list'));
      gridBtn.addEventListener('click', () => setView('grid'));
      setView('list'); // Í∏∞Î≥∏ Î¶¨Ïä§Ìä∏ Î∑∞
    });
  </script>
</Layout>